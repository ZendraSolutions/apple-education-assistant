<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Education - Centro Escolar</title>
    <meta name="description" content="Asistente de gestión del ecosistema educativo: ASM, Jamf School y App Aula">

    <!-- Security Headers -->
    <!-- Content Security Policy: Define trusted sources for content -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net;
        font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net;
        connect-src 'self' https://generativelanguage.googleapis.com;
        img-src 'self' data:;
        frame-ancestors 'none';
        base-uri 'self';
        form-action 'self';
    ">
    <!-- Prevent MIME type sniffing -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <!-- Control referrer information sent in requests -->
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <!-- Permissions Policy: Restrict browser features -->
    <meta http-equiv="Permissions-Policy" content="
        geolocation=(),
        microphone=(),
        camera=(),
        payment=(),
        usb=(),
        magnetometer=(),
        gyroscope=(),
        accelerometer=()
    ">

    <link rel="stylesheet" href="css/styles.css">

    <!-- Fonts y iconos se cargan condicionalmente según consentimiento RGPD (ver js/consent.js) -->

    <!-- Security: DOMPurify for XSS protection with Subresource Integrity -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.3.1/dist/purify.min.js"
            integrity="sha384-80VlBZnyAwkkqtSfg5NhPyZff6nU4K/qniLBL8Jnm4KDv6jZhLiYtJbhglg/i9ww"
            crossorigin="anonymous"></script>
</head>

<body>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="ri-graduation-cap-line logo-icon"></i>
                <span class="logo-text">Asistente Education</span>
            </div>
        </div>

        <div class="nav-section">
            <span class="nav-label">Principal</span>
            <ul class="nav-menu">
                <li class="nav-item active" data-section="dashboard">
                    <i class="ri-dashboard-line"></i> Dashboard
                </li>
                <li class="nav-item" data-section="ecosistema">
                    <i class="ri-flow-chart"></i> Ecosistema
                </li>
            </ul>
        </div>

        <div class="nav-section">
            <span class="nav-label">Herramientas Esenciales</span>
            <ul class="nav-menu">
                <li class="nav-item" data-section="aula">
                    <i class="ri-group-line"></i> App Aula
                </li>
                <li class="nav-item" data-section="teacher">
                    <i class="ri-presentation-line"></i> Jamf Teacher
                </li>
            </ul>
        </div>

        <div class="nav-section">
            <span class="nav-label">Dispositivos</span>
            <ul class="nav-menu">
                <li class="nav-item" data-section="ipads">
                    <i class="ri-tablet-line"></i> iPads Alumnado
                </li>
                <li class="nav-item" data-section="macs">
                    <i class="ri-macbook-line"></i> Macs Profesorado
                </li>
            </ul>
        </div>

        <div class="nav-section">
            <span class="nav-label">Soporte</span>
            <ul class="nav-menu">
                <li class="nav-item" data-section="troubleshooting">
                    <i class="ri-tools-line"></i> Troubleshooting
                </li>
            </ul>
        </div>

        <div class="nav-section">
            <span class="nav-label">Recursos</span>
            <ul class="nav-menu">
                <li class="nav-item" data-section="checklists">
                    <i class="ri-task-line"></i> Checklists
                </li>
            </ul>
        </div>

        <div class="nav-section">
            <span class="nav-label">Privacidad</span>
            <ul class="nav-menu">
                <li class="nav-item" data-section="mis-datos">
                    <i class="ri-shield-user-line"></i> Mis Datos
                </li>
            </ul>
        </div>

        <div class="sidebar-footer">
            <div class="theme-toggle-container">
                <button id="themeToggle" class="theme-btn" title="Cambiar tema">
                    <i class="ri-moon-line" id="themeIcon"></i>
                </button>
            </div>
            <div class="update-info" id="updateInfo">
                <i class="ri-book-open-line update-icon"></i>
                <span class="update-text">Cargando...</span>
            </div>
            <a href="https://learn.jamf.com" target="_blank" class="docs-link">
                <i class="ri-external-link-line"></i> Docs oficiales
            </a>
        </div>
    </nav>

    <!-- Overlay para cerrar sidebar en móvil -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <main class="main-content">
        <header class="top-bar">
            <button class="menu-toggle" id="menuToggle"><i class="ri-menu-2-line"></i></button>
            <div class="search-container">
                <div class="search-wrapper">
                    <i class="ri-search-line search-icon-input"></i>
                    <input type="text" class="search-input" id="searchInput" placeholder="Buscar soluciones...">
                </div>
            </div>
        </header>

        <div class="content-wrapper" id="contentWrapper">
            <!-- Content loaded dynamically -->
        </div>

        <!-- Footer Legal -->
        <footer class="legal-footer">
            <div class="legal-links">
                <a href="aviso-legal.html" target="_blank" class="legal-link">
                    <i class="ri-file-text-line"></i> Aviso Legal
                </a>
                <a href="politica-privacidad.html" target="_blank" class="legal-link">
                    <i class="ri-shield-check-line"></i> Política de Privacidad
                </a>
            </div>
            <div class="legal-info">
                <span>Tus datos se almacenan solo en este navegador</span>
            </div>
        </footer>
    </main>

    <div class="search-overlay" id="searchOverlay">
        <div class="search-results" id="searchResults"></div>
    </div>

    <div class="modal" id="guideModal">
        <div class="modal-content">
            <button class="modal-close" id="modalClose">✕</button>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Chatbot -->
    <div class="chatbot-fab" id="chatbotFab">
        <span class="fab-icon"><i class="ri-robot-line"></i></span>
        <span class="fab-badge" id="fabBadge"></span>
    </div>

    <div class="chatbot-panel" id="chatbotPanel">
        <div class="chatbot-header">
            <div class="chatbot-title">
                <i class="ri-robot-line"></i>
                <span>Asistente Jamf IA</span>
            </div>
            <div class="chatbot-actions">
                <button class="chatbot-settings" id="chatbotSettings" title="Configurar API"><i
                        class="ri-settings-3-line"></i></button>
                <button class="chatbot-close" id="chatbotClose">✕</button>
            </div>
        </div>
        <div class="chatbot-messages" id="chatbotMessages">
            <div class="chat-message bot">
                <div class="message-avatar"><i class="ri-robot-line"></i></div>
                <div class="message-content">
                    <p>¡Hola! Soy tu asistente del ecosistema educativo. Puedo ayudarte con:</p>
                    <ul>
                        <li>School Manager (ASM) y Jamf School</li>
                        <li>App Aula y gestión de clase</li>
                        <li>Gestión de iPads y Macs</li>
                        <li>Troubleshooting de problemas</li>
                    </ul>
                    <p>¿En qué puedo ayudarte hoy?</p>
                </div>
            </div>
        </div>
        <div class="chatbot-input-container">
            <input type="text" class="chatbot-input" id="chatbotInput" placeholder="Escribe tu pregunta...">
            <button class="chatbot-send" id="chatbotSend">
                <i class="ri-send-plane-fill"></i>
            </button>
        </div>
    </div>

    <!-- API Key Modal -->
    <div class="modal" id="apiModal">
        <div class="modal-content api-modal">
            <button class="modal-close" id="apiModalClose">✕</button>
            <div class="modal-body">
                <h2><i class="ri-settings-3-line"></i> Configurar API de IA</h2>
                <p>Para usar el asistente con IA, necesitas una API Key de Google Gemini (gratuita).</p>

                <div class="api-steps">
                    <div class="api-step">
                        <span class="step-num">1</span>
                        <span>Ve a <a href="https://aistudio.google.com/apikey" target="_blank">Google AI
                                Studio</a></span>
                    </div>
                    <div class="api-step">
                        <span class="step-num">2</span>
                        <span>Crea una API Key (es gratis)</span>
                    </div>
                    <div class="api-step">
                        <span class="step-num">3</span>
                        <span>Pégala aquí abajo:</span>
                    </div>
                </div>

                <div class="api-input-group">
                    <input type="password" id="apiKeyInput" class="api-key-input" placeholder="AIza..." autocomplete="off">
                    <button id="saveApiKey" class="save-api-btn">Guardar</button>
                </div>

                <div class="api-validation-info" id="apiValidationInfo" style="margin-top: 8px; font-size: 0.9em; color: #666;"></div>

                <div class="api-storage-options" style="margin-top: 16px;">
                    <label class="storage-checkbox">
                        <input type="checkbox" id="sessionApiKey">
                        <span><i class="ri-time-line"></i> Usar solo en esta sesión (se borra al cerrar navegador)</span>
                    </label>

                    <label class="storage-checkbox">
                        <input type="checkbox" id="pinApiKey">
                        <span><i class="ri-pushpin-line"></i> Anclar API Key (guardar permanentemente)</span>
                    </label>
                </div>

                <p class="pin-info">Si no marcas ninguna opción, la key se guardará cifrada por 24 horas.</p>

                <div class="api-status" id="apiStatus"></div>

                <div class="info-box" style="margin-top: 20px;">
                    <div class="info-icon"><i class="ri-shield-check-line"></i></div>
                    <div class="info-content">
                        <p><strong>Seguridad mejorada:</strong> Tu API Key se cifra con AES-256-GCM antes de guardarla en tu navegador. Solo se descifra cuando la necesitas. No se envía a ningún servidor externo.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RGPD Consent Banner -->
    <div class="consent-banner" id="consent-banner">
        <div class="consent-header">
            <div class="consent-icon">
                <i class="ri-shield-check-line"></i>
            </div>
            <h3 class="consent-title">Respetamos tu privacidad</h3>
        </div>
        <div class="consent-body">
            <p class="consent-description">
                Usamos servicios externos para mejorar tu experiencia. Al aceptar, permites la carga de Google Fonts y Remixicon. Al usar el chatbot IA, aceptas el uso de Google Gemini API.
            </p>
            <p class="consent-services">
                <strong>Servicios:</strong> Google Fonts, Remixicon (jsDelivr), Google Gemini API
            </p>
            <a href="politica-privacidad.html" class="consent-link" target="_blank">
                <i class="ri-file-text-line"></i> Ver política de privacidad
            </a>
        </div>
        <div class="consent-actions">
            <button class="consent-btn consent-btn-primary" id="consent-accept-all">
                <i class="ri-check-line"></i> Aceptar todo
            </button>
            <button class="consent-btn consent-btn-secondary" id="consent-essential">
                Solo necesarias
            </button>
            <button class="consent-btn consent-btn-text" id="consent-settings">
                <i class="ri-settings-3-line"></i> Configurar
            </button>
        </div>
    </div>

    <!-- Modal de Configuración de Consentimiento -->
    <div class="consent-settings-modal" id="consent-settings-modal">
        <div class="consent-modal-content">
            <div class="consent-modal-header">
                <h2><i class="ri-settings-3-line"></i> Configuración de cookies</h2>
                <button class="consent-modal-close" id="consent-modal-close">✕</button>
            </div>
            <div class="consent-modal-body">
                <p class="consent-intro">
                    Personaliza qué servicios externos quieres permitir. Puedes cambiar tus preferencias en cualquier momento desde la sección "Mis Datos" en el menú lateral.
                </p>

                <!-- Cookies Esenciales -->
                <div class="consent-option">
                    <div class="consent-option-header">
                        <div class="consent-option-title">
                            <i class="ri-lock-line"></i>
                            Cookies esenciales
                            <span class="consent-option-badge essential">Necesarias</span>
                        </div>
                        <label class="consent-toggle disabled">
                            <input type="checkbox" checked disabled>
                            <span class="consent-toggle-slider"></span>
                        </label>
                    </div>
                    <p class="consent-option-description">
                        Necesarias para el funcionamiento básico de la aplicación (localStorage, preferencias de tema).
                    </p>
                    <p class="consent-option-details">
                        Estas cookies no se pueden desactivar ya que son imprescindibles para que la aplicación funcione correctamente.
                    </p>
                </div>

                <!-- Google Fonts -->
                <div class="consent-option">
                    <div class="consent-option-header">
                        <div class="consent-option-title">
                            <i class="ri-font-size"></i>
                            Google Fonts
                            <span class="consent-option-badge optional">Opcional</span>
                        </div>
                        <label class="consent-toggle" id="toggle-fonts">
                            <input type="checkbox" id="consent-fonts">
                            <span class="consent-toggle-slider"></span>
                        </label>
                    </div>
                    <p class="consent-option-description">
                        Tipografía Outfit para una mejor experiencia visual. Si se desactiva, usaremos fuentes del sistema.
                    </p>
                    <p class="consent-option-details">
                        Proveedor: Google LLC | Cookies: Ninguna | Datos compartidos: Dirección IP (anonimizada)
                    </p>
                </div>

                <!-- Remixicon -->
                <div class="consent-option">
                    <div class="consent-option-header">
                        <div class="consent-option-title">
                            <i class="ri-emotion-line"></i>
                            Remixicon (jsDelivr)
                            <span class="consent-option-badge optional">Opcional</span>
                        </div>
                        <label class="consent-toggle" id="toggle-icons">
                            <input type="checkbox" id="consent-icons">
                            <span class="consent-toggle-slider"></span>
                        </label>
                    </div>
                    <p class="consent-option-description">
                        Biblioteca de iconos para una interfaz más clara y visual.
                    </p>
                    <p class="consent-option-details">
                        Proveedor: jsDelivr CDN | Cookies: Ninguna | Datos compartidos: Dirección IP (anonimizada)
                    </p>
                </div>

                <!-- Info Box -->
                <div class="consent-info-box">
                    <div class="consent-info-icon">
                        <i class="ri-information-line"></i>
                    </div>
                    <div class="consent-info-text">
                        <strong>Nota sobre el chatbot IA:</strong> Al usar el asistente con IA, aceptas que tus mensajes se envíen a Google Gemini API. Tu API Key se guarda solo en tu navegador (localStorage).
                    </div>
                </div>
            </div>
            <div class="consent-modal-footer">
                <button class="consent-btn consent-btn-secondary" id="consent-modal-cancel" onclick="document.getElementById('consent-settings-modal').classList.remove('active')">
                    Cancelar
                </button>
                <button class="consent-btn consent-btn-primary" id="consent-save-settings">
                    <i class="ri-save-line"></i> Guardar preferencias
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts: El orden importa - consent.js debe cargarse primero -->
    <script src="js/consent.js"></script>
    <script src="js/knowledge-base.js"></script>
    <script src="js/diagnostics.js"></script>
    <script src="js/chatbot.js"></script>
    <script src="js/app.js"></script>
</body>

</html>
